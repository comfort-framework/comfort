<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ChangeSetLoader.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">comfort</a> &gt; <a href="index.source.html" class="el_package">de.ugoe.cs.comfort.collection.loader</a> &gt; <span class="el_source">ChangeSetLoader.java</span></div><h1>ChangeSetLoader.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2017 University of Goettingen, Germany
 * 
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package de.ugoe.cs.comfort.collection.loader;

import static org.mongodb.morphia.aggregation.Group.grouping;
import static org.mongodb.morphia.aggregation.Group.push;

import com.github.danielfelgar.morphia.Log4JLoggerImplFactory;
import com.google.common.collect.HashMultiset;
import com.google.common.collect.Multiset;
import com.mongodb.MongoClient;
import com.mongodb.MongoClientURI;
import de.ugoe.cs.comfort.annotations.SupportsJava;
import de.ugoe.cs.comfort.annotations.SupportsPython;
import de.ugoe.cs.comfort.configuration.Database;
import de.ugoe.cs.comfort.configuration.GeneralConfiguration;
import de.ugoe.cs.comfort.configuration.LoaderConfiguration;
import de.ugoe.cs.comfort.data.ChangeSet;
import de.ugoe.cs.comfort.data.ProjectFiles;
import de.ugoe.cs.comfort.database.models.FileAggregation;
import de.ugoe.cs.comfort.exception.LoaderException;
import de.ugoe.cs.smartshark.model.File;
import de.ugoe.cs.smartshark.model.FileAction;
import de.ugoe.cs.smartshark.model.VCSSystem;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.*;
import org.bson.types.ObjectId;
import org.mongodb.morphia.Datastore;
import org.mongodb.morphia.Morphia;
import org.mongodb.morphia.logging.MorphiaLoggerFactory;
import org.mongodb.morphia.query.Query;


/**
 * @author Fabian Trautsch
 */
public class ChangeSetLoader extends BaseLoader {

<span class="fc" id="L54">    private final Morphia morphia = new Morphia();</span>

    public ChangeSetLoader(GeneralConfiguration generalConfiguration, LoaderConfiguration loaderConfiguration) {
<span class="fc" id="L57">        super(generalConfiguration, loaderConfiguration);</span>
<span class="fc" id="L58">    }</span>

    @SupportsJava
    @SupportsPython
    public ChangeSet loadData() throws LoaderException{
        // Set up log4j logging
<span class="fc" id="L64">        MorphiaLoggerFactory.reset();</span>
<span class="fc" id="L65">        MorphiaLoggerFactory.registerLogger(Log4JLoggerImplFactory.class);</span>

<span class="fc" id="L67">        Database databaseConfiguration = loaderConf.getDatabase();</span>

        // Map models
<span class="fc" id="L70">        morphia.mapPackage(&quot;de.ugoe.cs.smartshark.model&quot;);</span>
<span class="fc" id="L71">        morphia.mapPackage(&quot;de.ugoe.cs.comfort.database.models&quot;);</span>

<span class="fc" id="L73">        logger.debug(&quot;Connecting to database...&quot;);</span>
        // Create database connection
<span class="fc" id="L75">        MongoClientURI uri = new MongoClientURI(de.ugoe.cs.smartshark.Utils.createMongoDBURI(</span>
<span class="fc" id="L76">                databaseConfiguration.getUsername(),</span>
<span class="fc" id="L77">                databaseConfiguration.getPassword(),</span>
<span class="fc" id="L78">                databaseConfiguration.getHostname(),</span>
<span class="fc" id="L79">                String.valueOf(databaseConfiguration.getPort()),</span>
<span class="fc" id="L80">                databaseConfiguration.getAuthenticationDatabase(),</span>
<span class="fc" id="L81">                databaseConfiguration.getSSL()));</span>
<span class="fc" id="L82">        MongoClient mongoClient = new MongoClient(uri);</span>
<span class="fc" id="L83">        final Datastore datastore = morphia.createDatastore(mongoClient, databaseConfiguration.getDatabase());</span>
<span class="fc" id="L84">        datastore.ensureIndexes();</span>




        // Get project files first, so that we already have a separation of the files
        ProjectFiles projectFiles;
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">        if (generalConf.getLanguage().equals(&quot;python&quot;)) {</span>
<span class="nc" id="L92">            projectFiles = new ProjectFilesLoader(generalConf, null).loadPythonProjectFiles();</span>
        } else {
<span class="fc" id="L94">            projectFiles = new ProjectFilesLoader(generalConf, null).loadJavaProjectFiles();</span>
        }

        // Get the VCS so that we can use it for querying the files
<span class="fc" id="L98">        VCSSystem vcsSystem = datastore.createQuery(VCSSystem.class).field(&quot;url&quot;)</span>
<span class="fc" id="L99">                .equal(loaderConf.getVcsSystemUrl()).get();</span>

        // Get all code files from the database that belong to the files of the project
<span class="fc" id="L102">        Map&lt;ObjectId, Path&gt; fileIds = new HashMap&lt;&gt;();</span>
<span class="fc" id="L103">        datastore.createQuery(File.class)</span>
<span class="fc" id="L104">                .field(&quot;path&quot;).in(projectFiles.getCodeFilesWithoutProjectDirAsString())</span>
<span class="fc" id="L105">                .field(&quot;vcs_system_id&quot;).equal(vcsSystem.getId())</span>
<span class="fc" id="L106">                .project(&quot;id&quot;, true).project(&quot;path&quot;, true)</span>
<span class="fc" id="L107">            .forEach(file -&gt; fileIds.put(file.getId(), Paths.get(file.getPath())));</span>
<span class="fc" id="L108">        logger.debug(&quot;Found the following code files in the database: {}&quot;, fileIds);</span>

        // Get only test files from database that belong to the project
<span class="fc" id="L111">        Set&lt;ObjectId&gt; testFileIds = new HashSet&lt;&gt;();</span>
<span class="fc" id="L112">        datastore.createQuery(File.class)</span>
<span class="fc" id="L113">                .field(&quot;path&quot;).in(projectFiles.getTestFilesWithoutProjectDirAsString())</span>
<span class="fc" id="L114">                .field(&quot;vcs_system_id&quot;).equal(vcsSystem.getId())</span>
<span class="fc" id="L115">                .project(&quot;id&quot;, true)</span>
<span class="fc" id="L116">            .forEach(file -&gt; testFileIds.add(file.getId()));</span>
<span class="fc" id="L117">        logger.debug(&quot;Found the following test file ids in the database: {}&quot;, testFileIds);</span>



        // For each file, get the fileactions that touched these files (with aggregation it is faster)
<span class="fc" id="L122">        Query&lt;FileAction&gt; q = datastore.createQuery(FileAction.class).field(&quot;file_id&quot;).in(testFileIds);</span>
<span class="fc" id="L123">        Iterator&lt;FileAggregation&gt; aggregate = datastore.createAggregation(FileAction.class)</span>
<span class="fc" id="L124">                .match(q)</span>
<span class="fc" id="L125">                .group(&quot;file_id&quot;, grouping(&quot;commit_ids&quot;, push(&quot;commit_id&quot;)))</span>
<span class="fc" id="L126">                .aggregate(FileAggregation.class);</span>


<span class="fc" id="L129">        Map&lt;Path, Multiset&lt;Path&gt;&gt; changeMap = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">        while (aggregate.hasNext()) {</span>
<span class="fc" id="L131">            FileAggregation fA = aggregate.next();</span>
<span class="fc" id="L132">            Multiset&lt;Path&gt; changedTogetherWith = HashMultiset.create();</span>

<span class="fc bfc" id="L134" title="All 2 branches covered.">            for(ObjectId commitId : fA.getCommitIds()) {</span>
<span class="fc" id="L135">                datastore.createQuery(FileAction.class).field(&quot;commit_id&quot;).equal(commitId)</span>
<span class="fc" id="L136">                        .project(&quot;file_id&quot;, true).forEach(</span>
<span class="fc" id="L137">                            fileAction -&gt; changedTogetherWith.add(fileIds.get(fileAction.getFileId()))</span>
                );
<span class="fc" id="L139">            }</span>

            // Get test file as Path
<span class="fc" id="L142">            Path testFilePath = fileIds.get(fA.getFileId());</span>

            // Remove all nulls and the test itself from the list. Nulls can appear, as we only look at code files but
            // of course there are also other files in the repository that can be changed together with tests
<span class="fc" id="L146">            changedTogetherWith.removeIf(Objects::isNull);</span>
<span class="fc" id="L147">            changedTogetherWith.removeIf(testFilePath::equals);</span>
<span class="fc" id="L148">            changeMap.put(testFilePath, changedTogetherWith);</span>
<span class="fc" id="L149">            logger.debug(&quot;File {} changed together with: {}&quot;, testFilePath, changedTogetherWith);</span>
<span class="fc" id="L150">        }</span>

<span class="fc" id="L152">        ChangeSet changeSet = new ChangeSet(changeMap);</span>
<span class="fc" id="L153">        logger.debug(&quot;Created the following ChangeSet: {}&quot;, changeSet);</span>
<span class="fc" id="L154">        return changeSet;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>